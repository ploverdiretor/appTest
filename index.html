<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web MIDI Synthesizer</title>
    <style>
        body { font-family: monospace; margin: 20px;  width:95%;}
        #midi-status { font-weight: bold; }
        #midi-log { margin-top: 10px; padding: 10px; border: 1px solid #ccc; height: 100px; overflow-y: scroll; background-color: #f9f9f9; max-width: 800px; width:95%;}
        .log-message { padding: 3px 0; border-bottom: 1px solid #eee; }
        #field {display:flex; justify-content: start;}
        #field_right{width:50%;margin: 20px;}
        #field_left{width:50%; margin: 20px;}
    </style>
</head>
<body>
    <h1>Web MIDI Synthesizer</h1>
    <p>Status: <span id="midi-status">Not connected</span></p>
    <hr>
    <div id="field">
        <div id="field_left">
            <h3>Received MIDI Messages:</h3>
            <div id="midi-log"></div>
            <hr width="95%" align="left">
            <h3>Voice Assigner:</h3>
            <table border="1" width="800px"  style="border-collapse: collapse">
                <tr>
                    <td align="center" width="6.25%">0</td><td align="center" width="6.25%">1</td><td align="center" width="6.25%">2</td><td align="center" width="6.25%">3</td>
                    <td align="center" width="6.25%">4</td><td align="center" width="6.25%">5</td><td align="center" width="6.25%">6</td><td align="center" width="6.25%">7</td>
                    <td align="center" width="6.25%">8</td><td align="center" width="6.25%">9</td><td align="center" width="6.25%">10</td><td align="center" width="6.25%">11</td>
                    <td align="center" width="6.25%">12</td><td align="center" width="6.25%">13</td><td align="center" width="6.25%">14</td><td align="center" width="6.25%">15</td>
                </tr>
                <tr>
                    <td id="voice0" align="center"></td><td id="voice1" align="center"></td><td id="voice2" align="center"></td><td id="voice3" align="center"></td>
                    <td id="voice4" align="center"></td><td id="voice5" align="center"></td><td id="voice6" align="center"></td><td id="voice7" align="center"></td>
                    <td id="voice8" align="center"></td><td id="voice9" align="center"></td><td id="voice10" align="center"></td><td id="voice11" align="center"></td>
                    <td id="voice12" align="center"></td><td id="voice13" align="center"></td><td id="voice14" align="center"></td><td id="voice15" align="center"></td>
                </tr>
                <tr>
                    <td id="freq0val" align="center"></td><td id="freq1val" align="center"></td><td id="freq2val" align="center"></td><td id="freq3val" align="center"></td>
                    <td id="freq4val" align="center"></td><td id="freq5val" align="center"></td><td id="freq6val" align="center"></td><td id="freq7val" align="center"></td>
                    <td id="freq8val" align="center"></td><td id="freq9val" align="center"></td><td id="freq10val" align="center"></td><td id="freq11val" align="center"></td>
                    <td id="freq12val" align="center"></td><td id="freq13val" align="center"></td><td id="freq14val" align="center"></td><td id="freq15val" align="center"></td>
                </tr>
                <tr>
                    <td id="gain0val" align="center"></td><td id="gain1val" align="center"></td><td id="gain2val" align="center"></td><td id="gain3val" align="center"></td>
                    <td id="gain4val" align="center"></td><td id="gain5val" align="center"></td><td id="gain6val" align="center"></td><td id="gain7val" align="center"></td>
                    <td id="gain8val" align="center"></td><td id="gain9val" align="center"></td><td id="gain10val" align="center"></td><td id="gain11val" align="center"></td>
                    <td id="gain12val" align="center"></td><td id="gain13val" align="center"></td><td id="gain14val" align="center"></td><td id="gain15val" align="center"></td>
                </tr>
            </table><br>
            <hr width="95%" align="left">
        
            <table border="0">
                <tr><td><h3>Oscillator:</h3></td><td><button id="play">Play</button> <button id="stop">Stop</button></td></tr>
            </table>
            <hr width="95%" align="left">
        </div>
        <hr>
        <div id="field_right">
            <h3>Custom waveform:</h3>
            <table border="0">
            <tr><th>Harmonics</th><th>imag</th></tr>
            <tr><th>1</th><td><input type="range" min="0" max="1" step="0.01" id="imag1" value="1"/></td><td id="imag1val"></td></tr>
            <tr><th>2</th><td><input type="range" min="0" max="1" step="0.01" id="imag2" value="0.5"/></td><td id="imag2val"></td></tr>
            <tr><th>3</th><td><input type="range" min="0" max="1" step="0.01" id="imag3" value="0"/></td><td id="imag3val"></td></tr>
            <tr><th>4</th><td><input type="range" min="0" max="1" step="0.01" id="imag4" value="0"/></td><td id="imag4val"></td></tr>
            <tr><th>5</th><td><input type="range" min="0" max="1" step="0.01" id="imag5" value="0"/></td><td id="imag5val"></td></tr>
            <tr><th>6</th><th><input type="range" min="0" max="1" step="0.01" id="imag6" value="0"/></td><td id="imag6val"></td></tr>
            <tr><th>7</th><td><input type="range" min="0" max="1" step="0.01" id="imag7" value="0"/></td><td id="imag7val"></td></tr>
            </table>
            <br>
            <hr width="95%" align="left">
            <h3>Effect:</h3>
            <table>
            <tr><th>Panner</th></tr>
            <tr><th>PanSpeed</th><td><input type="range" id="panSpeed" min="3.5" max="7" step="0.01" value="3.5"/></td><td id="panSpeedVal"></td></tr>
            <tr><th>PanGain</th><td><input type="range" id="panGain" min="0" max="1" step="0.01" value="0.8"/></td><td id="panGainVal"></td></tr>
            <tr><td><br/></td></tr>
            <tr><th>Chorus</th><th></th></tr>
            <tr><th>Speed</th><td><input type="range" id="speed" min="0.1" max="10" step="0.1" value="7"/></td><td id="speedval"></td></tr>
            <tr><th>Depth</th><td><input type="range" id="depth" min="0.000" max="0.005" step="0.0001" value="0.0003"/></td><td id="depthval"></td></tr>
            <tr><th>Mix</th><td><input type="range" id="mix" min="0" max="1" step="0.01" value="0.4"/></td><td id="mixval"></td></tr>
            <tr><th>Output</th><td><input type="range" id="output" min="0" max="1" step="0.01" value="0.8"/></td><td id="outputval"></td></tr>

            <tr><td><br/></td></tr>
            <tr><th>Reverb</th><th></th></tr>
            <tr><th>Mix</th><td><input type="range" id="revlevel" min="0" max="1" step="0.01" value="0.5"/></td><td id="revlevelval"></td></tr>
            
            <tr><td><br/></td></tr>
            <tr><th>Master</th><td><input type="range" id="master" min="0" max="1" step="0.01" value="0.2"/></td><td id="masterval"></td></tr>
            </table>
        </div>
    </div>
    <script>
        // Request access to MIDI devices
    window.addEventListener("load", async ()=>{
        const keyTable = [  27.5, 29.13523509488062, 30.867706328507758,
                            32.70319566257483, 34.64782887210901, 36.70809598967595, 38.890872965260115, 41.20344461410874,
                            43.653528929125486, 46.2493028389543, 48.99942949771866, 51.91308719749314, 55.0, 58.27047018976124, 61.735412657015516,
                            65.40639132514966, 69.29565774421802, 73.4161919793519, 77.78174593052023, 82.40688922821748,
                            87.30705785825097, 92.4986056779086, 97.99885899543732, 103.82617439498628, 110.0, 116.54094037952248, 123.47082531403103,
                            130.8127826502993, 138.59131548843604, 146.8323839587038, 155.56349186104046, 164.81377845643496,
                            174.61411571650194, 184.9972113558172, 195.99771799087463, 207.65234878997256, 220.0, 233.08188075904496, 246.94165062806206,
                            261.6255653005986, 277.1826309768721, 293.6647679174076, 311.1269837220809, 329.6275569128699,
                            349.2282314330039, 369.9944227116344, 391.99543598174927, 415.3046975799451, 440.0, 466.1637615180899, 493.8833012561241,
                            523.2511306011972, 554.3652619537442, 587.3295358348151, 622.2539674441618, 659.2551138257398,
                            698.4564628660078, 739.9888454232688, 783.9908719634985, 830.6093951598903, 880.0, 932.3275230361799, 987.7666025122483,
                            1046.5022612023945, 1108.7305239074883, 1174.6590716696303, 1244.5079348883237, 1318.5102276514797,
                            1396.9129257320155, 1479.9776908465376, 1567.981743926997, 1661.2187903197805, 1760.0, 1864.6550460723597, 1975.5332050244965,
                            2093.004522404789, 2217.4610478149766, 2349.3181433392606, 2489.0158697766474, 2637.0204553029594,
                            2793.825851464031, 2959.955381693075, 3135.963487853994, 3322.437580639561, 3520.0, 3729.3100921447194, 3951.066410048993,
                            4186.009044809578];
        const noteNum = [   'C-1','C#-1','D-1','D#-1','E-1','F-1','F#-1','G-1','G#-1','A-1','A#-1','B-1',
                            'C0','C#0','D0','D#0','E0','F0','F#0','G0','G#0','A0','A#0','B0',
                            'C1','C#1','D1','D#1','E1','F1','F#1','G1','G#1','A1','A#1','B1',
                            'C2','C#2','D2','D#2','E2','F2','F#2','G2','G#2','A2','A#2','B2',
                            'C3','C#3','D3','D#3','E3','F3','F#3','G3','G#3','A3','A#3','B3',
                            'C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4',
                            'C5','C#5','D5','D#5','E5','F5','F#5','G5','G#5','A5','A#5','B5',
                            'C6','C#6','D6','D#6','E6','F6','F#6','G6','G#6','A6','A#6','B6',
                            'C7','C#7','D7','D#7','E7','F7','F#7','G7','G#7','A7','A#7','B7',
                            'C8','C#8','D8','D#8','E8','F8','F#8','G8','G#8','A8','A#8','B8',
                            'C9','C#9','D9','D#9','E9','F9','F#9','G9'];
        const ccType = [    '','モジュレーション','ブレスコントローラー','','フットコントローラー','ポルタメントタイム','データ入力 MSB','','バランスコントローラー','',
                            '','エクスプレッション','エフェクトコントローラー1','エフェクトコントローラー2','','','','','','',
                            '','','','','','','','','','',
                            '','','','モジュレーションホイール LSB','ブレスコントローラー LSB','','フットコントローラー LSB','ポルタメントタイム LSB','データ入力 MSB LSB','メインボリューム LSB',
                            'バランスコントローラー LSB','','パン LSB','エクスプレッション','エフェクトコントローラー1 LSB','エフェクトコントローラー2 LSB','','','','',
                            '','','','','','','','','','',
                            '','','','','サスティン','ポルタメント','ソステヌート','ソフトペダル','レガート・フットスイッチ','ホールド2',
                            '','','','','','','','','','',
                            '','','','','ポルタメントコントロール'];
        let midiNoteValue = 0
        let voice = ['OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF','OFF']
        let voiceFreq = [440,440,440,440,440,440,440,440,440,440,440,440,440,440,440,440]
        let voiceGain = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        let voiceIndex = 0
        for(let i=0;i<16;i++){
            const index = 'voice'+i
            document.getElementById(index).innerHTML = voice[i]
        }
        
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess()
                .then(onMIDISuccess, onMIDIFailure);
        } else {
            document.getElementById('midi-status').textContent = 'Web MIDI API is not supported in this browser.';
            document.getElementById('midi-status').style.color = 'red';
        }

        function onMIDISuccess(midiAccess) {
            const statusEl = document.getElementById('midi-status');
            statusEl.textContent = 'Connected. Waiting for input...';
            statusEl.style.color = 'green';

            // Get all input devices and loop through them
            const inputs = midiAccess.inputs.values();
            for (let input of inputs) {
                // Add a listener for the "midimessage" event to each input
                input.onmidimessage = handleMIDIMessage;
                console.log(`Connected to input: ${input.name}`);
            }
        }

        function onMIDIFailure(error) {
            document.getElementById('midi-status').textContent = `Failed to get MIDI access: ${error.message}`;
            document.getElementById('midi-status').style.color = 'red';
        }

        function handleMIDIMessage(event) {
            // event.data is a Uint8Array [status byte, data1, data2]
            
            const data = event.data; 
            let messageType = ''
            for (let i=0;i<data.length;i++){
                messageType = messageType + 'data['+i+']:0x'+data[i].toString(16).padStart(2,'0')+' '
            }
            messageType = messageType + '　'
            let midiText = ''
            const midiCh = data[0] & 0x0f
            const status = data[0]>>>4;
            
            switch(status){
                case 0x08:
                    midiText = 'Ch('+midiCh+')　Note Off('+noteNum[data[1]]+') velo:'+data[2].toString(10).padStart(3,'0')
                    for(let i=0;i<16;i++){
                        if(voice[i]===data[1]){
                            voice[i]='OFF'
                            const index = 'voice'+i
                            document.getElementById(index).innerHTML = voice[i]
                            const t0 = audioctx.currentTime;
                            const t1 = t0 + 0.01;
                            const textGain = 'gain'+i
                            const textGainVal = 'gain'+i+'val'
                            document.getElementById(textGainVal).innerHTML=0;
                            voiceGain[i]=0;
                            gain[i].gain.cancelAndHoldAtTime(t0)
                            gain[i].gain.linearRampToValueAtTime(0, t1)
                            break
                        }
                    }
                    break
                case 0x09:
                    midiNoteValue = parseInt(data[1])-21
                    midiText = 'Ch('+midiCh+')　Note On('+noteNum[data[1]]+') velo:'+data[2].toString(10).padStart(3,'0')+'　freq:'+keyTable[midiNoteValue].toFixed(2)
                    for(let i=0;i<16;i++){
                        if(voice[i]==='OFF'){
                            voice[i]=data[1]
                            const index = 'voice'+i
                            document.getElementById(index).innerHTML = voice[i]
                            document.getElementById('freq'+i+'val').innerHTML= keyTable[midiNoteValue].toFixed(2)
                            voiceFreq[i] = keyTable[midiNoteValue].toFixed(2);
                            const textGainVal = 'gain'+i+'val'
                            document.getElementById(textGainVal).innerHTML=1;
                            const t0 = audioctx.currentTime;
                            const t1 = t0 + 0.0005;
                            voiceGain[i]=1;
                            gain[i].gain.setValueAtTime(0, t0);
                            gain[i].gain.linearRampToValueAtTime(1, t1);
                            Setup()
                            SetupWave(i);
                            break
                        }
                    }
                    break
                case 0x0a:
                    break
                case 0x0b:
                    midiText = 'Ch('+midiCh+')　Control Change:'+ccType[data[1]]+'　Value:'+data[2].toString(10).padStart(3,'0')
                    break
                case 0x0c:
                    midiText = 'Ch('+midiCh+')　Program Change:'+data[1].toString(10).padStart(3,'0')
                    break
                case 0x0d:
                    midiText = 'Ch('+midiCh+')　Channel Pressure:'+data[1].toString(10).padStart(3,'0')
                    break
                case 0x0e:
                    const bendVal = parseInt(data[2]<<7) + parseInt(data[1])-8192
                    midiText = 'Ch('+midiCh+')　Pitch Wheel Change:'+ bendVal.toString(10)
                    break
                case 0x0f:
                    break
                default:
                    break
            }
            logMessage(messageType+midiText)

        }

        function logMessage(message) {
            const log = document.getElementById('midi-log');
            const entry = document.createElement('div');
            entry.className = 'log-message';
            entry.textContent = message;
            log.appendChild(entry);
            // Auto-scroll to the bottom
            log.scrollTop = log.scrollHeight;
        }

        /*--------------------------オシレーター-------------------------*/
        
        const audioctx = new AudioContext();
        var osc = []
        var gain = []
        for (let i=0;i<16;i++){
            osc[i] = new OscillatorNode(audioctx);
            gain[i] = new GainNode(audioctx);
        }
        const tablen = 8;
        const real = new Float32Array(tablen);
        const imag = new Float32Array(tablen);

        /*---------------------------ロータリー----------------------------*/

        const panner = new PannerNode(audioctx, {panningModel:"HRTF"});
        const panGain = new GainNode(audioctx);
        const panLfoGain = new GainNode(audioctx);
        panLfoGain.gain.value = 0.1
        panGain.gain.value = document.getElementById("panGain").value;
        const panLfo = new OscillatorNode(audioctx);
        panLfo.frequency.value = document.getElementById("panSpeed").value;
        panLfo.start()
        /*---------------------------コーラス----------------------------*/
        const lfo = new OscillatorNode(audioctx);
        const depth = new GainNode(audioctx);
        const delay = new DelayNode(audioctx, {delayTIme:0.02});
        const mix = new GainNode(audioctx);
        const output = new GainNode(audioctx);
        lfo.frequency.value = document.getElementById("speed").value;
        depth.gain.value = document.getElementById("depth").value;
        mix.gain.value = document.getElementById("mix").value;
        output.gain.value = document.getElementById("output").value;
        lfo.start();
        /*---------------------------リバーブ----------------------------*/
        const irbuf = await LoadSample(audioctx, "ir/s1_r1_bd.wav");
        const convolver = new ConvolverNode(audioctx, {buffer: irbuf});
        const revmix = new GainNode(audioctx);
        const drymix = new GainNode(audioctx);

        /*-----------------------------音量------------------------------*/
        const master = new GainNode(audioctx);

        /*-----------------------------接続------------------------------*/
        osc[0].connect(gain[0]).connect(panner).connect(panGain).connect(delay).connect(mix).connect(output).connect(convolver).connect(master).connect(audioctx.destination);
        for (let i=1;i<16;i++){
            osc[i].connect(gain[i]).connect(panner)
        }
        panGain.connect(output)
        panLfo.connect(panLfoGain).connect(panner.positionX)
        output.connect(drymix).connect(master)
        lfo.connect(depth).connect(delay.delayTime);
        
        /*-----------------------------初期化------------------------------*/
        audioctx.suspend();
        for (let i=0;i<16;i++){
            osc[i].start();  
        }
        document.getElementById("stop").addEventListener("click", ()=>{
            audioctx.suspend();
        });
        document.getElementById("play").addEventListener("click", ()=>{
            for (let i=0;i<16;i++){
                SetupWave(i);
            }
            audioctx.resume();
        });
        for(let i=1;i<8;++i){
            document.getElementById("imag"+i).addEventListener("input", ()=>{
                Setup()
                for (let j=0;j<16;j++){
                    SetupWave(j);
                }
            });
        }
        document.getElementById("panSpeed").addEventListener("input", Setup);
        document.getElementById("panGain").addEventListener("input", Setup);
        document.getElementById("speed").addEventListener("input", Setup);
        document.getElementById("depth").addEventListener("input", Setup);
        document.getElementById("mix").addEventListener("input", Setup);
        document.getElementById("output").addEventListener("input", Setup);
        document.getElementById("revlevel").addEventListener("input", Setup);
        document.getElementById("master").addEventListener("input", Setup);
        Setup();
        for (let j=0;j<16;j++){
            SetupWave(j);
        }
        audioctx.resume();

        /*-----------------------------セットアップ------------------------------*/
        function Setup(){
            for (let i=0;i<16;i++){
                const textKey = 'key'+i;
                const textFreqVal='freq'+i+'val';
                const textGain = 'gain'+i
                const textGainVal = 'gain'+i+'val'
            //    osc[i].frequency.value = keyTable[document.getElementById(textKey).value];
                osc[i].frequency.value = voiceFreq[i];
                document.getElementById(textFreqVal).innerHTML= voiceFreq[i];
                gain[i].gain.value = voiceGain[i];
                document.getElementById(textGainVal ).innerHTML= voiceGain[i];
            }

            panLfo.frequency.value = parseFloat(document.getElementById("panSpeedVal").innerHTML
                = document.getElementById("panSpeed").value);
            panGain.gain.value = document.getElementById("panGainVal").innerHTML
                = document.getElementById("panGain").value;
            panLfoGain.gain.value =1;

            const rev = document.getElementById("revlevel").value;
            revmix.gain.value = document.getElementById("revlevelval").innerHTML = rev;
            drymix.gain.value = 1 - rev;
            lfo.frequency.value = document.getElementById("speedval").innerHTML
                = document.getElementById("speed").value;
            depth.gain.value = document.getElementById("depthval").innerHTML
                = document.getElementById("depth").value;
            const mixval = document.getElementById("mixval").innerHTML
                = document.getElementById("mix").value;
            mix.gain.value = mixval;
            output.gain.value = document.getElementById("outputval").innerHTML
                = document.getElementById("output").value;
            master.gain.value = document.getElementById("masterval").innerHTML
                = document.getElementById("master").value;
        }
        /*-----------------------------ドローバー設定------------------------------*/
        function SetupWave(num){
            for(i = 0; i < tablen; i++) { // make Harmonics
                real[i] = 0;
                if(i!==0){
                imag[i] = parseFloat(document.getElementById("imag"+i+"val").innerHTML
                    = document.getElementById("imag"+i).value);
                }else{
                imag[i] = 0;
                }
            }
            const waveTable = audioctx.createPeriodicWave(real, imag);	//create periodicWave
            osc[num].setPeriodicWave(waveTable);
        }
        /*-----------------------------リバーブ設定------------------------------*/
        function LoadSample(actx, url) {
            return new Promise((resolv)=>{
                fetch(url).then((response)=>{
                    return response.arrayBuffer();
                }).then((arraybuf)=>{
                    return actx.decodeAudioData(arraybuf);
                }).then((buf)=>{
                    resolv(buf);
                })
            });
        }
    });
    </script>
</body>
</html>
