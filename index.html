<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web MIDI Synthesizer</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px; font-family: "monospace" ;}
        #midi-status { font-weight: bold; }
        #midi-log { margin-top: 10px; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: scroll; background-color: #f9f9f9; }
        .log-message { padding: 3px 0; border-bottom: 1px solid #eee; font-family: "monospace" ;}
    </style>
</head>
<body>
    <h1>Web MIDI Synthesizer</h1>
    <p>Connect a MIDI device and grant permission when prompted.</p><hr>
    <p>Status: <span id="midi-status">Not connected</span></p>
    
    <h3>Received MIDI Messages:</h3>
    <div id="midi-log"></div>

    <script>
        // Request access to MIDI devices
        const noteNum = [   'C-1','C#-1','D-1','D#-1','E-1','F-1','F#-1','G-1','G#-1','A-1','A#-1','B-1',
                            'C0','C#0','D0','D#0','E0','F0','F#0','G0','G#0','A0','A#0','B0',
                            'C1','C#1','D1','D#1','E1','F1','F#1','G1','G#1','A1','A#1','B1',
                            'C2','C#2','D2','D#2','E2','F2','F#2','G2','G#2','A2','A#2','B2',
                            'C3','C#3','D3','D#3','E3','F3','F#3','G3','G#3','A3','A#3','B3',
                            'C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4',
                            'C5','C#5','D5','D#5','E5','F5','F#5','G5','G#5','A5','A#5','B5',
                            'C6','C#6','D6','D#6','E6','F6','F#6','G6','G#6','A6','A#6','B6',
                            'C7','C#7','D7','D#7','E7','F7','F#7','G7','G#7','A7','A#7','B7',
                            'C8','C#8','D8','D#8','E8','F8','F#8','G8','G#8','A8','A#8','B8',
                            'C9','C#9','D9','D#9','E9','F9','F#9','G9'];
        const ccType = ['','モジュレーション','ブレスコントローラー','','フットコントローラー','ポルタメントタイム','データ入力 MSB','','バランスコントローラー','','','エクスプレッション','エフェクトコントローラー1','エフェクトコントローラー2','','','','','','','','','','','','','','','','','','','','モジュレーションホイール LSB','ブレスコントローラー LSB','','フットコントローラー LSB','ポルタメントタイム LSB','データ入力 MSB LSB','メインボリューム LSB','バランスコントローラー LSB','','パン LSB','エクスプレッション','エフェクトコントローラー1 LSB','エフェクトコントローラー2 LSB','','','','','','','','','','','','','','','','','','','サスティン','ポルタメント','ソステヌート','ソフトペダル','レガート・フットスイッチ','ホールド2','','','','','','','','','','','','','','','ポルタメントコントロール'];
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess()
                .then(onMIDISuccess, onMIDIFailure);
        } else {
            document.getElementById('midi-status').textContent = 'Web MIDI API is not supported in this browser.';
            document.getElementById('midi-status').style.color = 'red';
        }

        function onMIDISuccess(midiAccess) {
            const statusEl = document.getElementById('midi-status');
            statusEl.textContent = 'Connected. Waiting for input...';
            statusEl.style.color = 'green';

            // Get all input devices and loop through them
            const inputs = midiAccess.inputs.values();
            for (let input of inputs) {
                // Add a listener for the "midimessage" event to each input
                input.onmidimessage = handleMIDIMessage;
                console.log(`Connected to input: ${input.name}`);
            }
        }

        function onMIDIFailure(error) {
            document.getElementById('midi-status').textContent = `Failed to get MIDI access: ${error.message}`;
            document.getElementById('midi-status').style.color = 'red';
        }

        function handleMIDIMessage(event) {
            // event.data is a Uint8Array [status byte, data1, data2]
            
            const data = event.data; 
            let messageType = ''
            for (let i=0;i<data.length;i++){
                messageType = messageType + 'data['+i+']:0x'+data[i].toString(16).padStart(2,'0')+' '
            }
            messageType = messageType + '　'
            let midiText = ''
            const midiCh = data[0] & 0x0f
            const status = data[0]>>>4;
            switch(status){
                case 0x08:
                    midiText = 'MIDIch('+midiCh+')　Note Off('+noteNum[data[1]]+') velocity:'+data[2].toString(10).padStart(3,'0')
                    break
                case 0x09:
                    midiText = 'MIDIch('+midiCh+')　Note On('+noteNum[data[1]]+') velocity:'+data[2].toString(10).padStart(3,'0')
                    break
                case 0x0a:
                    break
                case 0x0b:
                    midiText = 'MIDIch('+midiCh+')　Control Change:'+ccType[data[1]]+'　Value:'+data[2].toString(10).padStart(3,'0')
                    break
                case 0x0c:
                    midiText = 'MIDIch('+midiCh+')　Program Change:'+data[1].toString(10).padStart(3,'0')
                    break
                case 0x0d:
                    midiText = 'MIDIch('+midiCh+')　Channel Pressure:'+data[1].toString(10).padStart(3,'0')
                    break
                case 0x0e:
                    const bendVal = parseInt(data[2]<<7) + parseInt(data[1])-8192
                    midiText = 'MIDIch('+midiCh+')　Pitch Wheel Change:'+ bendVal.toString(10)
                    break
                case 0x0f:
                    break
                default:
                    break
            }
            logMessage(messageType+midiText)

        }

        function logMessage(message) {
            const log = document.getElementById('midi-log');
            const entry = document.createElement('div');
            entry.className = 'log-message';
            entry.textContent = message;
            log.appendChild(entry);
            // Auto-scroll to the bottom
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>
