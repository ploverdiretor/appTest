<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web MIDI Synthesizer</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px; font-family: "monospace" ;}
        #midi-status { font-weight: bold; }
        #midi-log { margin-top: 10px; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: scroll; background-color: #f9f9f9; }
        .log-message { padding: 3px 0; border-bottom: 1px solid #eee; font-family: "monospace" ;}
    </style>
</head>
<body>
    <h1>Web MIDI Synthesizer</h1>
    <p>Connect a MIDI device and grant permission when prompted.</p><hr>
    <p>Status: <span id="midi-status">Not connected</span></p>
    
    <h3>Received MIDI Messages:</h3>
    <div id="midi-log"></div>
    <hr/>
    <div>
    <button id="play">Play</button> <button id="stop">Stop</button><br/>
    <table>
    <!--<tr><th>Freq</th><td><input type="range" id="freq" min="50" max="1000" value="440"/></td><td id="freqval"></td></tr>-->
    <tr><th>key</th><td><input type="range" id="key" min="0" max="87" step="1" value="48"/></td><td id="freqval"></td></tr>
    <tr><th>Gain</th><td><input type="range" id="gain" min="0" max="1" step="0.01" value="0.1"/></td><td id="gainval"></td></tr>

    <tr><td><br/></td></tr>
    <tr><th>Harmonics</th><th>imag</th></tr>
    <tr><th>1</th><td><input type="range" min="0" max="1" step="0.01" id="imag1" value="1"/></td><td id="imag1val"></td></tr>
    <tr><th>2</th><td><input type="range" min="0" max="1" step="0.01" id="imag2" value="0.5"/></td><td id="imag2val"></td></tr>
    <tr><th>3</th><td><input type="range" min="0" max="1" step="0.01" id="imag3" value="0"/></td><td id="imag3val"></td></tr>
    <tr><th>4</th><td><input type="range" min="0" max="1" step="0.01" id="imag4" value="0"/></td><td id="imag4val"></td></tr>
    <tr><th>5</th><td><input type="range" min="0" max="1" step="0.01" id="imag5" value="0"/></td><td id="imag5val"></td></tr>
    <tr><th>6</th><th><input type="range" min="0" max="1" step="0.01" id="imag6" value="0"/></td><td id="imag6val"></td></tr>
    <tr><th>7</th><td><input type="range" min="0" max="1" step="0.01" id="imag7" value="0"/></td><td id="imag7val"></td></tr>

    <tr><td><br/></td></tr>
    <tr><th>Chorus</th><th></th></tr>
    <tr><th>Speed</th><td><input type="range" id="speed" min="0.1" max="10" step="0.1" value="7"/></td><td id="speedval"></td></tr>
    <tr><th>Depth</th><td><input type="range" id="depth" min="0.000" max="0.005" step="0.0001" value="0.0003"/></td><td id="depthval"></td></tr>
    <tr><th>Mix</th><td><input type="range" id="mix" min="0" max="1" step="0.01" value="0.4"/></td><td id="mixval"></td></tr>
    <tr><th>Output</th><td><input type="range" id="output" min="0" max="1" step="0.01" value="0.8"/></td><td id="outputval"></td></tr>

    <tr><td><br/></td></tr>
    <tr><th>Reverb</th><th></th></tr>
    <tr><th>Mix</th><td><input type="range" id="revlevel" min="0" max="1" step="0.01" value="0.5"/></td><td id="revlevelval"></td></tr>

    </table>

    </div>
    <script>
        // Request access to MIDI devices
    window.addEventListener("load", async ()=>{
        const keyTable = [  27.5, 29.13523509488062, 30.867706328507758,
                            32.70319566257483, 34.64782887210901, 36.70809598967595, 38.890872965260115, 41.20344461410874,
                            43.653528929125486, 46.2493028389543, 48.99942949771866, 51.91308719749314, 55.0, 58.27047018976124, 61.735412657015516,
                            65.40639132514966, 69.29565774421802, 73.4161919793519, 77.78174593052023, 82.40688922821748,
                            87.30705785825097, 92.4986056779086, 97.99885899543732, 103.82617439498628, 110.0, 116.54094037952248, 123.47082531403103,
                            130.8127826502993, 138.59131548843604, 146.8323839587038, 155.56349186104046, 164.81377845643496,
                            174.61411571650194, 184.9972113558172, 195.99771799087463, 207.65234878997256, 220.0, 233.08188075904496, 246.94165062806206,
                            261.6255653005986, 277.1826309768721, 293.6647679174076, 311.1269837220809, 329.6275569128699,
                            349.2282314330039, 369.9944227116344, 391.99543598174927, 415.3046975799451, 440.0, 466.1637615180899, 493.8833012561241,
                            523.2511306011972, 554.3652619537442, 587.3295358348151, 622.2539674441618, 659.2551138257398,
                            698.4564628660078, 739.9888454232688, 783.9908719634985, 830.6093951598903, 880.0, 932.3275230361799, 987.7666025122483,
                            1046.5022612023945, 1108.7305239074883, 1174.6590716696303, 1244.5079348883237, 1318.5102276514797,
                            1396.9129257320155, 1479.9776908465376, 1567.981743926997, 1661.2187903197805, 1760.0, 1864.6550460723597, 1975.5332050244965,
                            2093.004522404789, 2217.4610478149766, 2349.3181433392606, 2489.0158697766474, 2637.0204553029594,
                            2793.825851464031, 2959.955381693075, 3135.963487853994, 3322.437580639561, 3520.0, 3729.3100921447194, 3951.066410048993,
                            4186.009044809578];
        const noteNum = [   'C-1','C#-1','D-1','D#-1','E-1','F-1','F#-1','G-1','G#-1','A-1','A#-1','B-1',
                            'C0','C#0','D0','D#0','E0','F0','F#0','G0','G#0','A0','A#0','B0',
                            'C1','C#1','D1','D#1','E1','F1','F#1','G1','G#1','A1','A#1','B1',
                            'C2','C#2','D2','D#2','E2','F2','F#2','G2','G#2','A2','A#2','B2',
                            'C3','C#3','D3','D#3','E3','F3','F#3','G3','G#3','A3','A#3','B3',
                            'C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4',
                            'C5','C#5','D5','D#5','E5','F5','F#5','G5','G#5','A5','A#5','B5',
                            'C6','C#6','D6','D#6','E6','F6','F#6','G6','G#6','A6','A#6','B6',
                            'C7','C#7','D7','D#7','E7','F7','F#7','G7','G#7','A7','A#7','B7',
                            'C8','C#8','D8','D#8','E8','F8','F#8','G8','G#8','A8','A#8','B8',
                            'C9','C#9','D9','D#9','E9','F9','F#9','G9'];
        const ccType = [    '','モジュレーション','ブレスコントローラー','','フットコントローラー','ポルタメントタイム','データ入力 MSB','','バランスコントローラー','',
                            '','エクスプレッション','エフェクトコントローラー1','エフェクトコントローラー2','','','','','','',
                            '','','','','','','','','','',
                            '','','','モジュレーションホイール LSB','ブレスコントローラー LSB','','フットコントローラー LSB','ポルタメントタイム LSB','データ入力 MSB LSB','メインボリューム LSB',
                            'バランスコントローラー LSB','','パン LSB','エクスプレッション','エフェクトコントローラー1 LSB','エフェクトコントローラー2 LSB','','','','',
                            '','','','','','','','','','',
                            '','','','','サスティン','ポルタメント','ソステヌート','ソフトペダル','レガート・フットスイッチ','ホールド2',
                            '','','','','','','','','','',
                            '','','','','ポルタメントコントロール'];
        let midiNoteValue = 0
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess()
                .then(onMIDISuccess, onMIDIFailure);
        } else {
            document.getElementById('midi-status').textContent = 'Web MIDI API is not supported in this browser.';
            document.getElementById('midi-status').style.color = 'red';
        }

        function onMIDISuccess(midiAccess) {
            const statusEl = document.getElementById('midi-status');
            statusEl.textContent = 'Connected. Waiting for input...';
            statusEl.style.color = 'green';

            // Get all input devices and loop through them
            const inputs = midiAccess.inputs.values();
            for (let input of inputs) {
                // Add a listener for the "midimessage" event to each input
                input.onmidimessage = handleMIDIMessage;
                console.log(`Connected to input: ${input.name}`);
            }
        }

        function onMIDIFailure(error) {
            document.getElementById('midi-status').textContent = `Failed to get MIDI access: ${error.message}`;
            document.getElementById('midi-status').style.color = 'red';
        }

        function handleMIDIMessage(event) {
            // event.data is a Uint8Array [status byte, data1, data2]
            
            const data = event.data; 
            let messageType = ''
            for (let i=0;i<data.length;i++){
                messageType = messageType + 'data['+i+']:0x'+data[i].toString(16).padStart(2,'0')+' '
            }
            messageType = messageType + '　'
            let midiText = ''
            const midiCh = data[0] & 0x0f
            const status = data[0]>>>4;
            
            switch(status){
                case 0x08:
                    midiText = 'Ch('+midiCh+')　Note Off('+noteNum[data[1]]+') velo:'+data[2].toString(10).padStart(3,'0')
                    break
                case 0x09:
                    midiNoteValue = parseInt(data[1])-21
                    midiText = 'Ch('+midiCh+')　Note On('+noteNum[data[1]]+') velo:'+data[2].toString(10).padStart(3,'0')+'　freq:'+keyTable[midiNoteValue].toFixed(3)+','+midiNoteValue
                    document.getElementById("key").value = midiNoteValue 
                    document.getElementById("freqval").innerHTML= Math.round(keyTable[document.getElementById("key").value]*1000)/1000
                    Setup()
                    break
                case 0x0a:
                    break
                case 0x0b:
                    midiText = 'Ch('+midiCh+')　Control Change:'+ccType[data[1]]+'　Value:'+data[2].toString(10).padStart(3,'0')
                    break
                case 0x0c:
                    midiText = 'Ch('+midiCh+')　Program Change:'+data[1].toString(10).padStart(3,'0')
                    break
                case 0x0d:
                    midiText = 'Ch('+midiCh+')　Channel Pressure:'+data[1].toString(10).padStart(3,'0')
                    break
                case 0x0e:
                    const bendVal = parseInt(data[2]<<7) + parseInt(data[1])-8192
                    midiText = 'Ch('+midiCh+')　Pitch Wheel Change:'+ bendVal.toString(10)
                    break
                case 0x0f:
                    break
                default:
                    break
            }
            logMessage(messageType+midiText)

        }

        function logMessage(message) {
            const log = document.getElementById('midi-log');
            const entry = document.createElement('div');
            entry.className = 'log-message';
            entry.textContent = message;
            log.appendChild(entry);
            // Auto-scroll to the bottom
            log.scrollTop = log.scrollHeight;
        }

        /*--------------------------オシレーター-------------------------*/
        const audioctx = new AudioContext();
        const osc = new OscillatorNode(audioctx);

        const tablen = 8;
        const real = new Float32Array(tablen);
        const imag = new Float32Array(tablen);

        /*---------------------------コーラス----------------------------*/
        const lfo = new OscillatorNode(audioctx);
        const depth = new GainNode(audioctx);
        const delay = new DelayNode(audioctx, {delayTIme:0.02});
        const mix = new GainNode(audioctx);
        const output = new GainNode(audioctx);
        lfo.frequency.value = document.getElementById("speed").value;
        depth.gain.value = document.getElementById("depth").value;
        mix.gain.value = document.getElementById("mix").value;
        output.gain.value = document.getElementById("output").value;
        lfo.start();
        /*---------------------------リバーブ----------------------------*/
        const irbuf = await LoadSample(audioctx, "ir/s1_r1_bd.wav");
        const convolver = new ConvolverNode(audioctx, {buffer: irbuf});
        const revmix = new GainNode(audioctx);
        const drymix = new GainNode(audioctx);

        /*-----------------------------音量------------------------------*/
        const gain = new GainNode(audioctx);

        /*-----------------------------接続------------------------------*/
        osc.connect(delay).connect(mix).connect(output).connect(convolver).connect(gain).connect(audioctx.destination);
        osc.connect(output)
        output.connect(drymix).connect(gain)
        lfo.connect(depth).connect(delay.delayTime);
        audioctx.suspend();
        osc.start();

        document.getElementById("stop").addEventListener("click", ()=>{
            audioctx.suspend();
        });
        document.getElementById("play").addEventListener("click", ()=>{
            SetupWave();
            audioctx.resume();
        });
        document.getElementById("key").addEventListener("input", Setup);
        document.getElementById("gain").addEventListener("input", Setup);
        for(let i=1;i<8;++i){
        document.getElementById("imag"+i).addEventListener("input", SetupWave);
        }

        document.getElementById("speed").addEventListener("input", Setup);
        document.getElementById("depth").addEventListener("input", Setup);
        document.getElementById("mix").addEventListener("input", Setup);
        document.getElementById("output").addEventListener("input", Setup);
        document.getElementById("revlevel").addEventListener("input", Setup);
        Setup();
        SetupWave();
        function Setup(){
            osc.frequency.value = keyTable[document.getElementById("key").value];
        //    osc.frequency.value = parseFloat(keyTable[midiNoteValue])
            document.getElementById("freqval").innerHTML= Math.round(keyTable[document.getElementById("key").value]*1000)/1000
            
            gain.gain.value = document.getElementById("gainval").innerHTML
                = document.getElementById("gain").value;
            const rev = document.getElementById("revlevel").value;
            revmix.gain.value = document.getElementById("revlevelval").innerHTML = rev;
            drymix.gain.value = 1 - rev;
            lfo.frequency.value = document.getElementById("speedval").innerHTML
                = document.getElementById("speed").value;
            depth.gain.value = document.getElementById("depthval").innerHTML
                = document.getElementById("depth").value;
            const mixval = document.getElementById("mixval").innerHTML
                = document.getElementById("mix").value;
            mix.gain.value = mixval;
            output.gain.value = document.getElementById("outputval").innerHTML
                = document.getElementById("output").value;
        }
        function SetupWave(){
            for(i = 0; i < tablen; i++) { // make Harmonics
                real[i] = 0;
                if(i!==0){
                imag[i] = parseFloat(document.getElementById("imag"+i+"val").innerHTML
                    = document.getElementById("imag"+i).value);
                }else{
                imag[i] = 0;
                }
            }
            const waveTable = audioctx.createPeriodicWave(real, imag);	//create periodicWave
            osc.setPeriodicWave(waveTable);	//set to Oscillator
        }
        function LoadSample(actx, url) {
            return new Promise((resolv)=>{
                fetch(url).then((response)=>{
                    return response.arrayBuffer();
                }).then((arraybuf)=>{
                    return actx.decodeAudioData(arraybuf);
                }).then((buf)=>{
                    resolv(buf);
                })
            });
        }
    });
    </script>
</body>
</html>
